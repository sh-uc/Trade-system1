name: export-feed
on:
  # 手動実行
  workflow_dispatch:
    inputs:
      note:
        description: "Optional note for this run"
        required: false
  # 任意: 指定パスに push されたら毎回実行（例：mainブランチの src/ or daily_task.py など）
  push:
    branches: [ main ]
    paths:
      - "daily_task.py"
      - "backtest_v2.py"
      - "bt_*.py"
      - "spec.md"
      - ".github/workflows/export_feed.yml"

permissions:
  contents: write
      

jobs:
  export:
    runs-on: ubuntu-latest
    concurrency:
      group: export-feed
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install supabase pandas python-dateutil

      - name: Export minimal feed (signals & runs) to docs/feed
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        run: |
          python - << 'PY'
          import os, json, pathlib
          from datetime import datetime, timezone
          from dateutil import tz
          from supabase import create_client

          sb = create_client(os.environ["SUPABASE_URL"], os.environ["SUPABASE_SERVICE_ROLE"])

          # ---- signals（列は実スキーマ準拠／action を decision というキー名で返す）
          sig_cols = "date,code,close,prev_close,diff_pct,decision:action,summary,reasons"
          sig_rows = sb.table("signals").select(sig_cols).order("date", desc=True).limit(2000).execute().data

          # ---- backtests_runs（実スキーマに存在する列のみ）
          run_cols = "id,created_at,started_at,ticker,params,final_equity,total_return,max_drawdown,sharpe,n_trades"
          runs_raw = sb.table("backtests_runs").select(run_cols).order("created_at", desc=True).limit(2000).execute().data

          # 表示用に metrics という入れ子を"こちら側で"組み立てる（スキーマは変えない）
          runs_rows = []
          for r in runs_raw:
            runs_rows.append({
              "id": r.get("id"),
              "created_at": r.get("created_at"),
              "started_at": r.get("started_at"),
              "ticker": r.get("ticker"),
              "params": r.get("params"),
              "metrics": {
                "final_equity": r.get("final_equity"),
                "total_return": r.get("total_return"),
                "max_drawdown": r.get("max_drawdown"),
                "sharpe": r.get("sharpe"),
                "n_trades": r.get("n_trades"),
              }
            })

          # ---- 出力
          root = pathlib.Path("docs/feed")
          (root/"history").mkdir(parents=True, exist_ok=True)
          (root/"latest").mkdir(parents=True, exist_ok=True)

          jst = tz.gettz("Asia/Tokyo")
          now = datetime.now(timezone.utc).astimezone(jst)
          ts  = now.strftime("%Y%m%d-%H%M%S")

          payload = {
            "generated_at": now.isoformat(),
            "signals": sig_rows,
            "runs": runs_rows
          }

          (root/"history"/f"feed_{ts}.json").write_text(json.dumps(payload, ensure_ascii=False, indent=2), encoding="utf-8")
          (root/"latest"/"signals.json").write_text(json.dumps(sig_rows, ensure_ascii=False, indent=2), encoding="utf-8")
          (root/"latest"/"runs.json").write_text(json.dumps(runs_rows, ensure_ascii=False, indent=2), encoding="utf-8")
          (root/"index.json").write_text(
            json.dumps({
              "updated_at": now.isoformat(),
              "latest": {"signals":"latest/signals.json","runs":"latest/runs.json"}
            }, ensure_ascii=False, indent=2),
            encoding="utf-8"
          )
          print(f"[export] wrote signals={len(sig_rows)} runs={len(runs_rows)} at {ts}")
          PY

      - name: Commit & push feed
        run: |
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

          git add docs/feed docs/index.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore(feed): update docs/feed ($(date -u +%Y-%m-%dT%H:%M:%SZ))"
            git push
          fi
                