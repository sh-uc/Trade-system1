name: export-feed
on:
  # 手動実行
  workflow_dispatch:
    inputs:
      note:
        description: "Optional note for this run"
        required: false
  # 任意: 指定パスに push されたら毎回実行（例：mainブランチの src/ or daily_task.py など）
  push:
    branches: [ main ]
    paths:
      - "daily_task.py"
      - "backtest_v2.py"
      - "bt_*.py"
      - "spec.md"
      - ".github/workflows/export_feed.yml"

jobs:
  export:
    runs-on: ubuntu-latest
    concurrency:
      group: export-feed
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install supabase pandas python-dateutil

      - name: Export minimal feed (signals & runs) to docs/feed
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        run: |
          python - << 'PY'
          import os, json, pathlib
          from datetime import datetime, timezone
          from dateutil import tz
          from supabase import create_client

          url = os.environ["SUPABASE_URL"]
          key = os.environ["SUPABASE_SERVICE_ROLE"]
          sb  = create_client(url, key)

          # ---- signals は '*' で取得。diff_pct が無ければ計算 or None
          sig_rows = sb.table("signals").select("*").limit(2000).execute().data
          for r in sig_rows:
            if "diff_pct" not in r:
              close = r.get("close"); prev = r.get("prev_close") or r.get("prev")
            if isinstance(close,(int,float)) and isinstance(prev,(int,float)) and prev:
              r["diff_pct"] = (close - prev)/prev*100.0
            else:
              r["diff_pct"] = None

            # ---- runs は '*' で取得し、Python 側でソートキーを柔軟に決定
            runs_rows = sb.table("backtests_runs").select("*").limit(2000).execute().data

          # ソートキー優先度（存在する最初のキーで並び替え）
          sort_keys = ["created_at","run_at","ts","updated_at","id"]
          key_found = next((k for k in sort_keys if runs_rows and k in runs_rows[0]), None)
          if key_found:
            try:
              runs_rows.sort(key=lambda x: x.get(key_found) or "", reverse=True)
            except Exception:
              pass

          # ---- 出力
          root = pathlib.Path("docs/feed"); (root/"history").mkdir(parents=True, exist_ok=True)
          (root/"latest").mkdir(parents=True, exist_ok=True)

          jst = tz.gettz("Asia/Tokyo")
          now = datetime.now(timezone.utc).astimezone(jst)
          ts  = now.strftime("%Y%m%d-%H%M%S")

          payload = { "generated_at": now.isoformat(), "signals": sig_rows, "runs": runs_rows }

          (root/"history"/f"feed_{ts}.json").write_text(json.dumps(payload, ensure_ascii=False, indent=2), encoding="utf-8")
          (root/"latest"/"signals.json").write_text(json.dumps(sig_rows, ensure_ascii=False, indent=2), encoding="utf-8")
          (root/"latest"/"runs.json").write_text(json.dumps(runs_rows, ensure_ascii=False, indent=2), encoding="utf-8")
          (root/"index.json").write_text(
          json.dumps({"updated_at": now.isoformat(),
                  "latest": {"signals":"latest/signals.json","runs":"latest/runs.json"}},
                 ensure_ascii=False, indent=2),
          encoding="utf-8"
          )
          print(f"[export] wrote signals={len(sig_rows)} runs={len(runs_rows)} at {ts} (sort={key_found})")
          PY

      - name: Commit & Push (docs/feed)
        run: |
          if ! git diff --quiet -- docs/feed ; then
            git config user.name  "feed-bot"
            git config user.email "feed-bot@example.com"
            git add docs/feed
            git commit -m "update feed"
            git push
          else
            echo "no changes"
          fi
