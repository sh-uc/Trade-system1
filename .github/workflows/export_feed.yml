name: export-feed
on:
  # 手動実行
  workflow_dispatch:
    inputs:
      note:
        description: "Optional note for this run"
        required: false
  # 任意: 指定パスに push されたら毎回実行（例：mainブランチの src/ or daily_task.py など）
  push:
    branches: [ main ]
    paths:
      - "daily_task.py"
      - "backtest_v2.py"
      - "bt_*.py"
      - "spec.md"
      - ".github/workflows/export_feed.yml"

jobs:
  export:
    runs-on: ubuntu-latest
    concurrency:
      group: export-feed
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install supabase pandas python-dateutil

      - name: Export minimal feed (signals & runs) to docs/feed
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        run: |
          python - << 'PY'
          import os, json, pathlib
          from datetime import datetime, timezone
          from dateutil import tz
          from supabase import create_client

          sb = create_client(os.environ["SUPABASE_URL"], os.environ["SUPABASE_SERVICE_ROLE"])

          # 必要列だけを明示的に取得
          sig_cols = "date,code,close,prev_close,diff_pct,decision:action,summary,reasons"
          sig_rows = sb.table("signals").select(sig_cols).order("date", desc=True).limit(2000).execute().data

          run_cols = "id,created_at,ticker,params,metrics"
          runs_rows = sb.table("backtests_runs").select(run_cols).order("created_at", desc=True).limit(2000).execute().data

          root = pathlib.Path("docs/feed"); (root/"history").mkdir(parents=True, exist_ok=True); (root/"latest").mkdir(exist_ok=True)
          jst = tz.gettz("Asia/Tokyo"); now = datetime.now(timezone.utc).astimezone(jst); ts = now.strftime("%Y%m%d-%H%M%S")

          payload = {"generated_at": now.isoformat(), "signals": sig_rows, "runs": runs_rows}
          (root/"history"/f"feed_{ts}.json").write_text(json.dumps(payload, ensure_ascii=False, indent=2), encoding="utf-8")
          (root/"latest"/"signals.json").write_text(json.dumps(sig_rows, ensure_ascii=False, indent=2), encoding="utf-8")
          (root/"latest"/"runs.json").write_text(json.dumps(runs_rows, ensure_ascii=False, indent=2), encoding="utf-8")
          (root/"index.json").write_text(json.dumps({
              "updated_at": now.isoformat(),
              "latest": {"signals":"latest/signals.json","runs":"latest/runs.json"}}, ensure_ascii=False, indent=2), encoding="utf-8")
          print(f"[export] wrote signals={len(sig_rows)} runs={len(runs_rows)} at {ts}")
          PY

      - name: Commit & Push (docs/feed)
        run: |
          if ! git diff --quiet -- docs/feed ; then
            git config user.name  "feed-bot"
            git config user.email "feed-bot@example.com"
            git add docs/feed
            git commit -m "update feed"
            git push
          else
            echo "no changes"
          fi
